<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-people-fill"></i> Members</h2>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-primary" (click)="openSyncModal()">
            <i class="bi bi-arrow-repeat"></i> Sync from Attendance
          </button>
          <button type="button" class="btn btn-primary" (click)="openCreateModal()">
            <i class="bi bi-plus-circle"></i> Add Member
          </button>
        </div>
      </div>

      <!-- Error Alert -->
      <div class="alert alert-danger" *ngIf="error" role="alert">
        <i class="bi bi-exclamation-triangle"></i> {{ error }}
        <button type="button" class="btn-close" (click)="error = ''"></button>
      </div>

      <!-- Loading Spinner -->
      <div class="text-center" *ngIf="loading">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>

      <!-- Members Table -->
      <div class="card" *ngIf="!loading">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Members List</h5>
            <span class="badge bg-primary">{{ members.length }} members</span>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>#</th>
                  <th>Name</th>
                  <th>Combat Power</th>
                  <th>GCash Number</th>
                  <th>GCash Name</th>
                  <th>Created</th>
                  <th>Updated</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let member of members; let i = index">
                  <td class="text-muted">{{ i + 1 }}</td>
                  <td>
                    <strong>{{ member.name }}</strong>
                  </td>
                  <td>
                    <span class="badge bg-success">{{ member.combatPower | number }}</span>
                  </td>
                  <td>
                    <span *ngIf="member.gcashNumber; else noGcashNumber" class="text-muted">
                      {{ member.gcashNumber }}
                    </span>
                    <ng-template #noGcashNumber>
                      <span class="text-muted fst-italic">Not set</span>
                    </ng-template>
                  </td>
                  <td>
                    <span *ngIf="member.gcashName; else noGcashName" class="text-muted">
                      {{ member.gcashName }}
                    </span>
                    <ng-template #noGcashName>
                      <span class="text-muted fst-italic">Not set</span>
                    </ng-template>
                  </td>
                  <td class="text-muted small">{{ formatDate(member.createdAtUtc) }}</td>
                  <td class="text-muted small">{{ formatDate(member.updatedAtUtc) }}</td>
                  <td class="text-end">
                    <div class="btn-group btn-group-sm">
                      <button type="button" class="btn btn-outline-primary" (click)="openEditModal(member)" title="Edit">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button type="button" class="btn btn-outline-danger" (click)="openDeleteModal(member)" title="Delete">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="card-footer text-muted" *ngIf="members.length === 0">
          <div class="text-center py-3">
            <i class="bi bi-people display-4 text-muted"></i>
            <p class="mt-2">No members found. Add some members or sync from attendance.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create Member Modal -->
<div class="modal fade" [class.show]="showCreateModal" [style.display]="showCreateModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-person-plus"></i> Add New Member</h5>
        <button type="button" class="btn-close" (click)="closeModals()"></button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="createMember()">
          <div class="mb-3">
            <label for="createName" class="form-label">Name *</label>
            <input type="text" class="form-control" id="createName" [(ngModel)]="createForm.name" name="name" required>
          </div>
          <div class="mb-3">
            <label for="createCombatPower" class="form-label">Combat Power *</label>
            <input type="number" class="form-control" id="createCombatPower" [(ngModel)]="createForm.combatPower" name="combatPower" min="0" required>
          </div>
          <div class="mb-3">
            <label for="createGcashNumber" class="form-label">GCash Number</label>
            <input type="text" class="form-control" id="createGcashNumber" [(ngModel)]="createForm.gcashNumber" name="gcashNumber" placeholder="09XXXXXXXXX">
          </div>
          <div class="mb-3">
            <label for="createGcashName" class="form-label">GCash Name</label>
            <input type="text" class="form-control" id="createGcashName" [(ngModel)]="createForm.gcashName" name="gcashName" placeholder="Account holder name">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModals()">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="createMember()">Create Member</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Member Modal -->
<div class="modal fade" [class.show]="showEditModal" [style.display]="showEditModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-pencil"></i> Edit Member</h5>
        <button type="button" class="btn-close" (click)="closeModals()"></button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="updateMember()">
          <div class="mb-3">
            <label for="editName" class="form-label">Name *</label>
            <input type="text" class="form-control" id="editName" [(ngModel)]="editForm.name" name="name" required>
          </div>
          <div class="mb-3">
            <label for="editCombatPower" class="form-label">Combat Power *</label>
            <input type="number" class="form-control" id="editCombatPower" [(ngModel)]="editForm.combatPower" name="combatPower" min="0" required>
          </div>
          <div class="mb-3">
            <label for="editGcashNumber" class="form-label">GCash Number</label>
            <input type="text" class="form-control" id="editGcashNumber" [(ngModel)]="editForm.gcashNumber" name="gcashNumber" placeholder="09XXXXXXXXX">
          </div>
          <div class="mb-3">
            <label for="editGcashName" class="form-label">GCash Name</label>
            <input type="text" class="form-control" id="editGcashName" [(ngModel)]="editForm.gcashName" name="gcashName" placeholder="Account holder name">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModals()">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="updateMember()">Update Member</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Member Modal -->
<div class="modal fade" [class.show]="showDeleteModal" [style.display]="showDeleteModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-danger"><i class="bi bi-exclamation-triangle"></i> Delete Member</h5>
        <button type="button" class="btn-close" (click)="closeModals()"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete <strong>{{ selectedMember?.name }}</strong>?</p>
        <p class="text-muted small">This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModals()">Cancel</button>
        <button type="button" class="btn btn-danger" (click)="deleteMember()">Delete Member</button>
      </div>
    </div>
  </div>
</div>

<!-- Sync Modal -->
<div class="modal fade" [class.show]="showSyncModal" [style.display]="showSyncModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-arrow-repeat"></i> Sync from Attendance</h5>
        <button type="button" class="btn-close" (click)="closeModals()"></button>
      </div>
      <div class="modal-body">
        <div *ngIf="!syncResult">
          <p>This will scan all attendance records and create new member entries for any unique attendees that don't already exist in the members list.</p>
          <p class="text-muted small">New members will be created with a default combat power of 0.</p>
        </div>
        <div *ngIf="syncResult" class="alert alert-success">
          <h6><i class="bi bi-check-circle"></i> Sync Completed</h6>
          <ul class="mb-0">
            <li>Total unique attendees found: {{ syncResult.totalAttendees }}</li>
            <li>New members added: {{ syncResult.newMembersAdded }}</li>
            <li>Total members now: {{ syncResult.totalMembers }}</li>
          </ul>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModals()">Close</button>
        <button type="button" class="btn btn-primary" (click)="syncFromAttendance()" *ngIf="!syncResult && !loading">
          <i class="bi bi-arrow-repeat"></i> Start Sync
        </button>
        <button type="button" class="btn btn-primary" disabled *ngIf="loading">
          <span class="spinner-border spinner-border-sm" role="status"></span> Syncing...
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div class="modal-backdrop fade show" *ngIf="showCreateModal || showEditModal || showDeleteModal || showSyncModal"></div>
