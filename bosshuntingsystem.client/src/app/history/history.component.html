<div class="cardx span-12">

  
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div class="fw-semibold">Defeat History</div>
    <div class="small text-muted">Most recent first</div>
  </div>
  <div *ngIf="loading" class="text-muted">Loading…</div>
  <div class="table-responsive" *ngIf="!loading">
    <table class="table align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>Boss</th>

          <th>Defeated At (UTC)</th>
          <th>Loots</th>
          <th>Attendees</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let r of rows">
          <td class="it-title">{{ r.bossName }}</td>

          <td class="text-secondary">{{ r.defeatedAtUtc ? dateUtils.formatUtcForDisplay(r.defeatedAtUtc) : 'History Entry' }}</td>
          <td>
            <span class="truncate" [title]="(r.loots || []).join(', ')">
              <ng-container *ngFor="let l of r.loots; let last = last">{{ l }}<span *ngIf="!last">, </span></ng-container>
            </span>
          </td>
          <td>
            <span class="truncate" [title]="(r.attendees || []).join(', ')">
              <ng-container *ngFor="let a of r.attendees; let last = last">{{ a }}<span *ngIf="!last">, </span></ng-container>
            </span>
          </td>
          <td class="text-end">
            <div class="d-flex gap-1 justify-content-end">
              <button class="btn btn-sm btn-outline-primary" (click)="openDetails(r)">View Details</button>
              <button class="btn btn-sm btn-outline-primary" 
                      (click)="openModal(r, 'loot')" 
                      title="Add Loot">
                Add Loot
              </button>
              <button class="btn btn-sm btn-outline-secondary" 
                      (click)="openModal(r, 'attendee')" 
                      title="Add Attendance">
                Add Attendance
              </button>
              <button class="btn btn-sm btn-outline-danger" 
                      (click)="deleteHistory(r)" 
                      title="Delete">
                Delete
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Modal -->
  <div class="modal" tabindex="-1" [class.show]="modalOpen || detailsOpen" [style.display]="(modalOpen || detailsOpen) ? 'block' : 'none'" style="background: rgba(0,0,0,.4);">
    <div class="modal-dialog">
      <div class="modal-content vh-75 overflow-auto">
        <ng-container *ngIf="detailsOpen; else addForm">
          <div class="modal-header">
            <h5 class="modal-title">History Details</h5>
            <button type="button" class="btn-close" (click)="closeDetails()"></button>
          </div>
          <div class="modal-body" *ngIf="details">
            <div class="mb-2"><strong>Boss:</strong> {{ details.bossName }}</div>

            <div class="mb-2"><strong>Defeated:</strong> {{ details.defeatedAtUtc ? dateUtils.formatUtcForDisplay(details.defeatedAtUtc) : 'History Entry (Not Actually Defeated)' }}</div>
            <hr>
            <div class="mb-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>Loots</strong>
                <div class="d-flex align-items-center gap-2">
                  <span class="badge text-bg-secondary">{{ details.loots?.length || 0 }} items</span>
                  <span class="badge text-bg-success" *ngIf="getTotalLootValue(details) > 0">
                    Total: ₱{{ getTotalLootValue(details) | number:'1.2-2' }}
                  </span>
                </div>
              </div>
              <div class="table-responsive" *ngIf="details.loots && details.loots.length > 0">
                <table class="table table-sm table-striped">
                  <thead class="table-light">
                    <tr>
                      <th>#</th>
                      <th>Loot Item</th>
                      <th>Price</th>
                      <th class="text-end">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let loot of details.loots; let i = index">
                      <td class="text-muted">{{ i + 1 }}</td>
                      <td>{{ loot }}</td>
                      <td>
                        <div class="input-group input-group-sm">
                          <span class="input-group-text">₱</span>
                          <input 
                            type="number" 
                            class="form-control form-control-sm" 
                            [value]="details.lootItems?.[i]?.price || ''" 
                            (change)="onPriceChange($event, details, i)"
                            placeholder="0.00"
                            min="0"
                            step="0.01"
                            style="max-width: 120px;">
                        </div>
                      </td>
                      <td class="text-end">
                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                (click)="removeLoot(details, i)" 
                                title="Remove loot"
                                aria-label="Remove loot">
                          <i class="bi bi-trash"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="text-muted small" *ngIf="!details.loots || details.loots.length === 0">
                No loot items recorded
              </div>
            </div>
            
            <div class="mb-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>Attendees</strong>
                <span class="badge text-bg-secondary">{{ details.attendees?.length || 0 }} players</span>
              </div>
              <div class="table-responsive" *ngIf="details.attendees && details.attendees.length > 0">
                <table class="table table-sm table-striped">
                                     <thead class="table-light">
                     <tr>
                       <th>#</th>
                       <th>Player Name</th>
                       <th class="text-end">Actions</th>
                     </tr>
                   </thead>
                  <tbody>
                                         <tr *ngFor="let attendee of details.attendees; let i = index">
                       <td class="text-muted">{{ i + 1 }}</td>
                       <td>{{ attendee }}</td>
                       <td class="text-end">
                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                (click)="removeAttendee(details, i)" 
                                title="Remove attendee"
                                aria-label="Remove attendee">
                          <i class="bi bi-trash"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="text-muted small" *ngIf="!details.attendees || details.attendees.length === 0">
                No attendees recorded
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" (click)="closeDetails()">Close</button>
            <button class="btn btn-outline-primary" 
                    (click)="openModal(details!, 'loot')" 
                    title="Add Loot">
              Add Loot
            </button>
            <button class="btn btn-outline-secondary me-2" 
                    (click)="openModal(details!, 'attendee')" 
                    title="Add Attendance">
              Add Attendance
            </button>
            <button class="btn btn-outline-danger" 
                    (click)="deleteHistory(details!)" 
                    title="Delete Record">
              Delete Record
            </button>
          </div>
        </ng-container>
        <ng-template #addForm>
          <div class="modal-header">
            <h5 class="modal-title">{{ modalMode === 'loot' ? 'Add Loot' : 'Add Attendance' }}</h5>
            <button type="button" class="btn-close" (click)="closeModal()"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3" *ngIf="modalMode === 'loot' || modalMode === 'attendee'">
              <label class="form-label small text-muted">Upload screenshot (optional)</label>
              <input type="file" accept="image/*" class="form-control" (change)="onImageSelected($event)">
              <div class="small text-muted mt-1" *ngIf="ocrLoading">Analyzing image…</div>
              <div class="small text-success mt-1" *ngIf="ocrSuggestions.length">Found {{ ocrSuggestions.length }} {{ modalMode === 'loot' ? 'loot' : 'attendee' }} candidate(s)</div>
              <div class="small text-success" *ngIf="ocrAddedCount">Added {{ ocrAddedCount }} new {{ modalMode === 'loot' ? 'loot' : 'attendee' }}(s)</div>
              <div class="mt-2" *ngIf="ocrSuggestions.length">
                <div class="small text-muted mb-1">Click to use a suggestion:</div>
                <div class="d-flex flex-wrap gap-2">
                  <button class="btn btn-sm btn-outline-secondary" *ngFor="let s of ocrSuggestions" (click)="modalValue = s">{{ s }}</button>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label small text-muted">{{ modalMode === 'loot' ? 'Loot' : 'Attendee' }}</label>
              <input class="form-control" [(ngModel)]="modalValue" (keyup.enter)="submitModal()">
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" (click)="closeModal()">Cancel</button>
            <button class="btn btn-primary" (click)="submitModal()">Add</button>
          </div>
        </ng-template>
      </div>
    </div>
  </div>
</div>


